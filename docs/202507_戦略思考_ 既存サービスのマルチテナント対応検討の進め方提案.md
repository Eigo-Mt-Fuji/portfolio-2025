9# 戦略思考 x 既存サービスのマルチテナント対応検討の進め方

## やりたいこと

昨年学んだ、暗記する戦略思考をイメージしながら
既存サービスのマルチテナント対応検討の進め方を考える

今回は、リアリティ・スイッチ x フチドリ思考で思考環境が整えてから、「条件分岐」を考える、「戦略の方向性」が変わる条件を見極める。「そのまんま」を前提とする思考パスもすこし活用します。

## 詳細

- 結論としては、既存サービスのマルチテナント対応検討の進め方は
    - まず、そもそもテナント単位でリソースを分けるのはどのような理由か。実際の狙いを確認するためのMTGを開催します
      - アウトプットは、たとえば以下のようなシンプルな達成したいことを箇条書きにし、強いて言えばどれが一番なのかを考えるというイメージです。 `ここでスイッチ7 わかった後の行動を考える。特に○○vs○○の形で行動の分岐を軸とする思考パスをもっとちゃんと使い、次のステップに移りやすくする`
        - 1. 特定顧客の性能要求・特需に対応できるリソースを提供する

        - 2. リソース配分調整を可能にし、コストパフォーマンス効率を最適化する
        

        - 3. SLA/SLO、セキュリティ上の説明責任を達成しやすくするため、テナント単位で独立したリソースを提供する

      - 進め方について検討した側としては、特定の顧客だけ需要が大きいので専用のリソースが割り当てたり、需要が顧客ごとにかなり違うので、ニーズに合わせて調節したり配分を調節したいのではと考えられます。この点も認識の相違がないか確認したいです
    - 次に、トータルのインフラコストと運用負担を上げてでも、ショップテナント単位のリソース配分をやりたいのか、それとも、現状のまま実現したいのかを協議します。この結果によって以下のように進め方が変わると思います
      - 現状を変えず、なるべく簡単に安く実現したい場合
        - これはつまり、ゼロから作り直して、金と時間をかけて、システムを最適化すれば、マルチテナント対応のシステムに生まれ変わらせることはできるかもしれませんが、ビジネス目的なので、なるべく現状のまま手堅く実現したい場合の進め方です。アーキテクチャをなるべくいじらずに、特定顧客グループ（１社を含む）ごとにリソースを割り当てたり、ニーズに合わせて調整できる仕組みを検討します
        - 具体的には、ワーカータイプのコンポーネントについて、ECSタスクの構成を維持したまま、ECSクラスタのタスク配置戦略、オートスケーリングポリシーの調整による実現性の検討を進めます。リアルタイムに呼ばれるWeb APIサービスの場合、それだけでなくリクエスト内容に基づいて顧客を識別して、適切なサーバーに処理を振り分ける方法を考えます。データベースは基本的にはいじらずにプランを組み立てます
      - 逆に、アーキテクチャ変更も辞さない、トータルのインフラコストと運用負担を上げてでも達成したい目標の場合
        - 目的に合わせて、最適な仕組みを考える場合どうなるかを考える
          - 適用先は、プロダクト全体か、特定のコンポーネントか。
          - 利用するプラットフォームや全体アーキテクチャから考え直す
          - そのために、よくある事例を調べたり、プランを作成し、比較する
- リアリティ・スイッチ x フチドリ思考
  - テナント単位でのリソース割り当ての具体的な特徴について考えてみると、
    - メリットとしては、顧客ごとにリソースが分離されることによるサービスレベルの向上や、トータルコストは同じでも、より多くのリソースをより多くのお金を落としてくれる顧客に配分できた場合、ビジネス上のパフォーマンスを高められます
    - デメリットとしては、テナント単位でリソースを割り当てる場合、特に現在アーキテクチャでの注意として、サーバには最小リソース要件があるので、中身が全く同一でも、分割するたびに費用と運用の効率が悪くなるという問題があります。
      - OSやミドルウェア、アプリケーション起動させ、維持するコストがそれぞれに発生するからです
    - 対応案を考えてみた場合、従量課金性のサーバレスシステムを使ったり、教科書通りのマルチテナントアーキテクチャへの切り替えなど、アーキテクチャを変える選択肢と、そうではなく現状のまま実現性を探る方向性の２種類があります
    - 教科書通りのマルチテナントアーキテクチャへの切り替えなどを行う場合、労力とリスクが大きくなり、コストも上がる傾向があります。かといって、現状のまま実現性を探ろうとすると、変更作業量と裏腹に難易度が高くなり、逆に高コストにもなり得ます。これらは内容次第です
    - 特にアーキテクチャを変える前提で考える場合は、ビジネス上、無視できない課題（例えば以下のような点）に直面し破綻する可能性もあります
      - 無視できない課題とは、コストや運用が犠牲にされたり、それを避けようとして逆にメリットが失われたり、最悪の場合作業量、スケジュール、リスクが許容範囲を超えて、実現性が失われること
    - マルチテナント対応を求められているのはそもそもなぜか(要確認)
      - マルチテナント対応と言っても、顧客ごとに専用のリソースを割り当てたいというよりは、特定の顧客だけ需要が大きいので専用のリソースが割り当てたり、ニーズに合わせて調節したい
      - テナント単位でリソースを割り当てるというよりは、需要が顧客ごとにかなり違うので、配分を調節したい
      - できれば、それぞれの顧客のインフラの独立させて管理しやすくする方法を探している

- 条件分岐を考える
  - これを踏まえると、重要な選択肢として、以下の２つの分岐があると考えられます。
    - トータルのインフラコストと運用負担を上げてでも、ショップテナント単位のリソース配分をやりたいのか、それとも、現状のまま実現したいのか
    - プラットフォームのアーキテクチャを大きく変更してでもやりたいのか、それともまず現状のまま直近で実現したいのか
  - そもそもなぜやりたいのか。達成したいビジネス目標によって手段が変わるので、目標を３つに分けて考えます
    - 特定顧客の性能要求・特需に対応できるリソースを提供する
    - リソース配分調整を可能にし、コストパフォーマンス効率を最適化する
    - SLA/SLO、セキュリティ上の説明責任を達成しやすくするため、テナント単位で独立したリソースを提供する

- そのまんま思考
  - ゼロから作り直して、金と時間をかけて、システムを最適化すれば、マルチテナント対応のシステムに生まれ変わらせることはできるかもしれません
  - お金に糸目をつけず、社運をかけて最適解を実現したい場合も確かにあります
  - しかし、ビジネス目的なら、マルチテナント対応によって利益を出すのが狙いのはず。
  - 特に、すでにサービスを運用している場合、なるべく簡単に安く手に入るに越したことはないはず。
  - ここでは、コストと運用、アーキテクチャを現状のままで、ECSクラスタとタスク配置戦略の調整による実現を考えます
    - 特定の顧客だけ需要が大きいので専用のリソースが割り当てたり、需要が顧客ごとにかなり違うので、ニーズに合わせて調節したり配分を調節したい

## 備考: 暗記戦略思考のパターン

- リアリティ・スイッチ x フチドリ思考(思考環境が整う)
    - スイッチ01 大学1年生の英語留学っぽく考えてみると
    - スイッチ09 定員割れ大学問題っぽく考えてみると
- わかった後の行動を考える。特に○○vs○○の形で行動の分岐を軸とする思考パス
    - STEP1. 調べる vs 解く 
      - スイッチ07 フランススーパーっぽく考えてみる

- 「条件分岐」を考える。特に「戦略の方向性」が変わる条件を見極める思考パス
    - あらゆる手段で調べたがまだわからない現実が存在する時
        - スイッチ11 すごい素材っぽく考えてみると ( 「条件分岐」を考える。特に「戦略の方向性」が変わる条件を見極める思考パス )
- 現状把握。誰かに聞かないと議論しないとわからないことを見極める
    - 問題を解くための登場人物を把握する。
        - スイッチ04 コインランドリー参入問題っぽく考えてみると
        - スイッチ05 スギ花粉っぽく考えてみると

- 課題を発見する時の１つの指針。深く考える切り口。
    - スイッチ02 カインズっぽく考えてみると ( 誰が敵なのか 特に、消費者／ユーザーがお金を使うまでの「分岐」を詳らかにする思考パス )
    - スイッチ03 車の教習所っぽく考えてみると(どこがホームでどこがアウェイかを考える。 地理的／視覚的に「勝ちゲーム」か「負けゲーム」かを詳（つまび）らかにしていく思考パス )
    - スイッチ08 QBハウスっぽく考えてみると( ターゲットとの「距離」を考える。 「どの層がターゲットになりやすいか？」の序列をつける思考パス)

- 一度、引いて考えてみる
    - STEP7. 課題が揃った時、一度、引いて考えてみる
        - スイッチ06 打倒セブンっぽく考えてみると(「本当に競合は誰か？」を考える。特に、目の前の敵は競合か？を疑う思考パス)
        - スイッチ12 年間パスポートっぽく考えてみると( そのまんま思考. 「最も難しく」考える。広告を打つ・単価を上げるといった飛び道具に頼るなどもっての外で「そのまんま」を前提とする思考パス )

- 論点を研ぐ
    - 同質化
        - 主論点の定義
            - 依頼された課題は、依頼主にとって事業のコアかコンテキストか。
                - もしも、依頼主にとってその課題が事業のコアではない場合（コンテキスト寄りの場合）、時間をかけて最適解を求めるスタイルより、短時間で効率的な課題解決の方が重視されやすいだろう。
                    - 或いは、場合によってはそもそもやらなくて済む適当な理由づけの方が期待されていることさえある。

                - 個人事業で依頼された課題の多くは、業務を外部に委託する程には、依頼主の事業環境と距離が離れていることも多い。
                    - ここでは、その課題が事業のコアではない場合（コンテキスト寄りの場合）を前提として、短時間で効率的な課題解決を目指すことについて考えていく。

                - 短時間で効率的な課題解決といえば、現行踏襲。
                    - なぜならば変化を起こす必要がないため、さまざまなリスクや作業負荷を回避できる可能性が高いと考えられるから。
                    - しかしながら、現行が常に正しいとは限らない。現行に合わせたことで問題の解決策を見誤ったりゴールに到達できないのでは本末転倒。
                    - またこれまでの経験上、現在の状況を認識したり、再現するために調査や認識合わせが必要になるなど、現行踏襲したことで逆に負担が大きくなることもある。
                    - 新規と現行踏襲の２つのプランは、その特徴から仕事の進め方が大きく異なるため、途中で相互の切り替えが発生すると手戻りが大きくなることに注意が必要と考える。

                - このことから
                    - 現行踏襲で進めた場合と、新たに設計して進めた場合、それぞれゴールに到達する為の条件と、どちらが短時間で効率的な課題解決につながるか（時間）
                    - そもそも課題に取り組む必要がなくなる条件

                - この２つについて考えていくことにしたい。
        - 最低限の情報収集
          - 主論点に対する主な取り組みと、基礎的な情報
            - TBD
        - 論点・仮説の書き下し
            - TBD
        - 認識点検
            - TBD
    - 前提の自覚
        - 論点からのサルベージ
        - 仮説からのサルベージ
        - 7つの論点からの推察
            - 定義: 社内での用語の定義
            - プレイヤー: 競合
            - セグメント: 製品別
            - シチュエーション: 外部環境、内部環境
            - バリューチェーン: 販売
            - マネタイズ: 現金化?
            - 時間軸: 3年後など
        - ラベリング
    - 前提を問い直す
        - 漏れ、妥当性、あえて
    - 核心をつく
    - 再構築する